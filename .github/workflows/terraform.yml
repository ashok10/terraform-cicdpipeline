name: Terraform CI/CD

on: 
  push: 
    branches: 
        - dev
        - master
env: 
  TF_VERSION: 1.5.0
  AWS_REGION: eu-north-1

jobs:
    terraform:
        name: Terraform
        runs-on: ubuntu_latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: ${{env.TF_VERSION}}

        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v2
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}
       
        - name: Terraform init
          run: terraform init
        
        - name: Select or Create Workspace
          run: |
            BRANCH_NAME=$(echo "${GITHUB_REF##*/}")
            terraform workspace select $BRANCH_NAME || terraform workspace new $BRANCH_NAME

        - name: Terraform format
          run: terraform format
        
        - name: Terraform validate
          run: terraform validate
          
        - name: Terraform plan
          run: terraform plan -out=tfplan
        
        - name: Terraform Apply (only on main)
          if: github.ref == 'refs/heads/master'
          run: terraform apply -auto-approve tfplan
        
              
              

